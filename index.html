<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Score CPB-AKIP - Calculateur de Risque d'IRA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f9;
        }
        .font-title {
            font-family: 'Montserrat', sans-serif;
        }
        .details-marker {
            transition: transform 0.3s ease;
        }
        details[open] .details-marker {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app-container" class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="font-title text-3xl md:text-4xl font-bold text-gray-800">Score CPB-AKIP</h1>
            <p class="text-lg text-gray-600 mt-2">Calculateur de Risque d'Insuffisance Rénale Aiguë Post-CEC</p>
        </header>

        <div id="error-container" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-6" role="alert">
            <p class="font-bold">Erreur de communication</p>
            <p id="error-message">Impossible de charger les données nécessaires depuis le serveur.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div id="form-container">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-title text-2xl font-semibold text-gray-700">Données du patient</h2>
                    <div>
                        <button id="reset-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors">Réinitialiser</button>
                    </div>
                </div>
                <form id="aki-form" class="space-y-6"></form>
                <button id="calculate-btn" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition-transform transform hover:scale-105">
                    Calculer le risque
                </button>
                <div class="mt-4 flex items-center justify-center space-x-4">
                    <button id="save-btn" class="text-sm text-blue-600 hover:underline">Sauvegarder le cas</button>
                    <label for="load-input" class="text-sm text-blue-600 hover:underline cursor-pointer">Charger un cas</label>
                    <input type="file" id="load-input" class="hidden" accept=".json">
                </div>
            </div>

            <div id="results-container" class="bg-gray-50 p-6 rounded-xl">
                <h2 class="font-title text-2xl font-semibold text-gray-700 mb-4">Résultats</h2>
                <div id="results-content" class="text-center text-gray-500">
                    <p>Les résultats s'afficheront ici après le calcul.</p>
                </div>
                <div id="shap-container" class="mt-6">
                     <h3 class="font-title text-xl font-semibold text-gray-700 mb-2">Facteurs d'influence</h3>
                    <div id="shap-chart-container" style="height:400px; display:none;">
                         <canvas id="shap-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('aki-form');
        const calculateBtn = document.getElementById('calculate-btn');
        const resultsContent = document.getElementById('results-content');
        const resetBtn = document.getElementById('reset-btn');
        const saveBtn = document.getElementById('save-btn');
        const loadInput = document.getElementById('load-input');
        const shapChartContainer = document.getElementById('shap-chart-container');
        let shapChart = null;

        // Conteneurs d'erreur
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');

        function showError(message) {
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        async function createForm() {
            try {
                // Cet appel est crucial et échoue probablement sur Render
                const response = await fetch('/metadata');
                if (!response.ok) {
                    throw new Error(`Le serveur a répondu avec une erreur: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                
                const featureOrder = data.numerical_ranges ? Object.keys(data.numerical_ranges) : [];
                const allFeatures = { ...data.numerical_ranges, ...data.feature_value_maps };

                featureOrder.forEach(key => {
                    const el = allFeatures[key];
                    let inputHtml = '';
                    if (el.values) { // Categorical
                        const options = el.labels.map((label, i) => `<option value="${el.values[i]}">${label}</option>`).join('');
                        inputHtml = `<label for="${key}" class="block text-sm font-medium text-gray-700">${key.replace(/_/g, ' ')}</label>
                                     <select id="${key}" name="${key}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">${options}</select>`;
                    } else { // Numerical
                        inputHtml = `<label for="${key}" class="block text-sm font-medium text-gray-700">${key.replace(/_/g, ' ')}</label>
                                     <input type="number" id="${key}" name="${key}" min="${el.min}" max="${el.max}" step="${el.step || 'any'}" placeholder="ex: ${el.mean.toFixed(2)}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">`;
                    }
                    form.innerHTML += `<div class="form-group">${inputHtml}</div>`;
                });
            } catch (error) {
                // AMÉLIORATION : Affiche une erreur claire si le chargement échoue
                console.error("Erreur lors de la création du formulaire:", error);
                showError(`Impossible de construire le formulaire. Veuillez vérifier les logs du serveur sur Render. Détail : ${error.message}`);
                calculateBtn.disabled = true;
                calculateBtn.textContent = 'Erreur de chargement';
                calculateBtn.classList.add('bg-red-500', 'cursor-not-allowed');
            }
        }

        async function handleCalculate(event) {
            event.preventDefault();
            const formData = new FormData(form);
            const payload = {};
            for (let [key, value] of formData.entries()) {
                if (value !== '') payload[key] = parseFloat(value);
            }

            resultsContent.innerHTML = `<p>Calcul en cours...</p>`;
            calculateBtn.disabled = true;

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Erreur de prédiction: ${response.statusText}`);
                const result = await response.json();
                displayResults(result);

                const explainResponse = await fetch('/explain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!explainResponse.ok) throw new Error(`Erreur d'explication: ${explainResponse.statusText}`);
                const explainResult = await explainResponse.json();
                displayShapChart(explainResult, result.probability_of_ira);

            } catch (error) {
                // AMÉLIORATION : Affiche une erreur si le calcul échoue
                console.error("Erreur lors du calcul:", error);
                resultsContent.innerHTML = `<div class="text-red-500"><strong>Erreur lors du calcul :</strong> ${error.message}.</div>`;
            } finally {
                calculateBtn.disabled = false;
            }
        }
        
        // ... (Le reste des fonctions displayResults, displayShapChart, etc. ne changent pas)
        function displayResults(result) {
            const probability = (result.probability_of_ira * 100).toFixed(2);
            const riskClass = result.is_at_risk ? 'text-red-600' : 'text-green-600';
            const riskText = result.is_at_risk ? 'Élevé' : 'Faible';
            resultsContent.innerHTML = `
                <div class="text-center">
                    <div class="text-5xl font-bold ${riskClass}">${probability}%</div>
                    <div class="text-lg text-gray-600 mt-2">Probabilité d'IRA</div>
                    <div class="mt-4 text-xl font-semibold ${riskClass}">Risque ${riskText}</div>
                    <p class="text-sm text-gray-500 mt-1">(Seuil de risque utilisé: ${(result.optimal_threshold_used * 100).toFixed(1)}%)</p>
                </div>
            `;
        }
        
        function displayShapChart(explainResult, finalPrediction) {
            const { base_value, shap_values } = explainResult;
            const sortedShap = Object.entries(shap_values).sort(([, a], [, b]) => Math.abs(b) - Math.abs(a));
            
            const topN = 15;
            const dataToShow = sortedShap.slice(0, topN).reverse();
            
            const labels = dataToShow.map(([feature]) => feature);
            const values = dataToShow.map(([, shap]) => shap);

            const waterfallData = [];
            let cumulative = base_value;
            waterfallData.push([0, base_value]); // Start bar
            
            for(const shap of values) {
                const start = cumulative;
                const end = cumulative + shap;
                waterfallData.push([start, end]);
                cumulative = end;
            }
            waterfallData.push([0, cumulative]); // End bar should match prediction
            
            const chartLabels = ['Valeur de Base', ...labels, 'Prédiction Finale'];

            if(shapChart) shapChart.destroy();
            
            shapChartContainer.style.display = 'block';
            const ctx = document.getElementById('shap-chart').getContext('2d');
            shapChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: waterfallData,
                        backgroundColor: (context) => {
                            if (context.dataIndex === 0 || context.dataIndex === chartLabels.length - 1) return 'rgba(75, 192, 192, 0.8)';
                            const value = context.raw[1] - context.raw[0];
                            return value > 0 ? 'rgba(255, 99, 132, 0.8)' : 'rgba(54, 162, 235, 0.8)';
                        },
                        borderColor: (context) => {
                            if (context.dataIndex === 0 || context.dataIndex === chartLabels.length - 1) return 'rgba(75, 192, 192, 1)';
                            const value = context.raw[1] - context.raw[0];
                            return value > 0 ? 'rgba(255, 99, 132, 1)' : 'rgba(54, 162, 235, 1)';
                        },
                        borderWidth: 1,
                        barPercentage: 0.8
                    }]
                },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataIndex === 0) return `Valeur de base: ${context.raw[1].toFixed(4)}`;
                                    if (context.dataIndex === context.chart.data.labels.length - 1) return `Prédiction finale: ${context.raw[1].toFixed(4)}`;
                                    const shapValue = context.raw[1] - context.raw[0];
                                    return `Impact (SHAP): ${shapValue.toFixed(4)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Probabilité de risque (score du modèle)' } },
                        y: { ticks: { font: { size: 10 } } }
                    }
                }
            });
        }
        
        function resetForm() {
            form.reset();
            resultsContent.innerHTML = '<p>Les résultats s\'afficheront ici après le calcul.</p>';
            if(shapChart) shapChart.destroy();
            shapChartContainer.style.display = 'none';
        }

        function saveCase() {
            const formData = new FormData(form);
            const payload = {};
            for (let [key, value] of formData.entries()) {
                if (value !== '') payload[key] = value;
            }
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().slice(0, 10);
            a.download = `cas_patient_${date}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadCase(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = JSON.parse(e.target.result);
                resetForm();
                for (const key in data) {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = data[key];
                    }
                }
            };
            reader.readAsText(file);
        }
        
        createForm();
        calculateBtn.addEventListener('click', handleCalculate);
        resetBtn.addEventListener('click', resetForm);
        saveBtn.addEventListener('click', saveCase);
        loadInput.addEventListener('change', loadCase);
    });
    </script>
</body>
</html>
